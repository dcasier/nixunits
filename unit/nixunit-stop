#!/bin/bash
set -eo pipefail

. _NIXUNITS_PATH_SED_/bin/common.sh

interface_ovs_delete() {
  log_msg "Delete OVS interface - $INTERFACE - "
  if ovs_port_exists "$INTERFACE"; then
    ovs_port_del "$INTERFACE"
  fi
}

log_block_msg "### nixunits STOP"

NS_PID=$(host_exec "ps --ppid $MAINPID -o pid h")

UNWANTED=$(pid_in_ns_not_in_container "$NS_PID")

for p in $UNWANTED; do
  log_msg "Kill pid $p"
  [ -d "/proc/$p" ] && kill "$p" 2>/dev/null
done
sleep 1
UNWANTED=$(for p in $UNWANTED; do [ -d "/proc/$p" ] && echo "$p"; done)
[ -z "$UNWANTED" ] || sleep 6

UNWANTED=$(pid_in_ns_not_in_container "$NS_PID")
for p in $UNWANTED; do
  log_msg "Kill -9 pid $p"
  [ -d "/proc/$p" ] && kill -9 "$p" 2>/dev/null
done

machinectl poweroff "$NAME" 2>/dev/null || true

for _ in $(seq 1 90); do
  if ! machinectl status "$NAME" >/dev/null 2>&1; then
    break
  fi
  sleep 1
done

if machinectl status "$NAME" >/dev/null 2>&1; then
  machinectl terminate "$NAME"
  for _ in $(seq 1 60); do
    machinectl status "$NAME" >/dev/null 2>&1 || exit 0
    sleep 1
  done
fi

if machinectl status "$NAME" >/dev/null 2>&1; then
  echo "SIGKILL !"
  machinectl kill "$NAME" --signal=SIGKILL 2>/dev/null || true
fi

systemctl reset-failed "nixunits-network@${NAME}.service" "machine-${NAME}.scope" 2>/dev/null || true

for iface in $(interfaces_list); do
  interface_env "$iface"
  if [ -n "$OVS_BRIDGE" ]; then
    interface_ovs_delete
  fi
done

log_block_msg "### nixunits STOP END"
